{"status":{},"contains_secrets":false,"product_version":"3.1.0","spec":{"description":"","resources":{"client_attrs":{"None":{"Profile":{"AHV":{"Action":{},"dsl_name":"AHV"}},"Package":{"Package1":{"Action":{},"dsl_name":"Package1"},"Package2":{"Action":{},"dsl_name":"Package2"},"Package3":{"Action":{},"dsl_name":"Package3"}},"Substrate":{"WindowsAHV":{"Action":{},"AhvVm":{"@@{calm_application_name}@@":{"dsl_name":"calm_application_name"}},"dsl_name":"WindowsAHV"},"DeploymentWorkbench":{"Action":{},"dsl_name":"DeploymentWorkbench"},"CitrixStudio":{"Action":{},"dsl_name":"CitrixStudio"}},"Service":{"Windows":{"Action":{},"dsl_name":"Windows"},"MDT":{"Action":{},"dsl_name":"MDT"},"Citrix":{"Action":{},"dsl_name":"Citrix"}},"Deployment":{"eee8c0ac_deployment":{"Action":{},"dsl_name":"eee8c0ac_deployment"},"8b1c1f67_deployment":{"Action":{},"dsl_name":"_8b1c1f67_deployment"},"ba70c687_deployment":{"Action":{},"dsl_name":"ba70c687_deployment"}}}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___create___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___create___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___create___dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for starting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___start___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___start___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___start___dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___stop___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___stop___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___stop___dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___delete___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___delete___dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___restart___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___restart___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___restart___dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Windows___soft_delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Windows___soft_delete___runbook","main_task_local_reference":{"kind":"app_task","name":"Windows___soft_delete___dag"},"variable_list":[]},"name":"action_soft_delete"}],"depends_on_list":[],"name":"Windows","port_list":[],"tier":"","variable_list":[],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"CommonPackageInstall"}],"name":"Citrix___create___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CommonPackageInstall","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"Citrix_CommonPackageInstall_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"Citrix___create___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___create___dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for starting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Citrix___start___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Citrix___start___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___start___dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Citrix___stop___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Citrix___stop___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___stop___dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Citrix___delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Citrix___delete___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___delete___dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Citrix___restart___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Citrix___restart___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___restart___dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Citrix___soft_delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Citrix___soft_delete___runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix___soft_delete___dag"},"variable_list":[]},"name":"action_soft_delete"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"Citrix_CTX_Create_Machine_Catalog_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"exit_status":[],"script":"$CTX_MACHINE_CATALOG_NAME = \"@@{CTX_MACHINE_CATALOG_NAME}@@\" # Machine Catalog name\n$CTX_MACHINE_CATALOG_DESCRIPTION = \"@@{CTX_MACHINE_CATALOG_DESCRIPTION}@@\" # Description includes reference to \"Managed by Calm\"\n$CTX_MACHINE_CATALOG_ALLOCATION = \"@@{CTX_MACHINE_CATALOG_ALLOCATION}@@\" # Random or Static (Random is default)\n$CTX_MACHINE_CATALOG_PROVISIONING = \"@@{CTX_MACHINE_CATALOG_PROVISIONING}@@\" # MCS or PVS (only MCS for now)\n$CTX_MACHINE_CATALOG_SESSION = \"@@{CTX_MACHINE_CATALOG_SESSION}@@\" # SingleSession or MultiSession (SingleSession is default)\n$CTX_MACHINE_CATALOG_PERSISTUSER = \"@@{CTX_MACHINE_CATALOG_PERSISTUSER}@@\" # OnLocal, Discard or OnPvd (OnPvd is default and only applies if Allocation is static. If Random then Discard is only option)\n$CTX_MACHINE_CATALOG_VCPU = \"@@{CTX_MACHINE_CATALOG_VCPU}@@\"\n$CTX_MACHINE_CATALOG_RAM = \"@@{CTX_MACHINE_CATALOG_RAM}@@\"\n$CTX_MACHINE_CATALOG_NAMING = \"@@{CTX_MACHINE_CATALOG_NAMING}@@\" # Example 'Machine-###'\n$CTX_MACHINE_CATALOG_NAMING_TYPE = \"@@{CTX_MACHINE_CATALOG_NAMING_TYPE}@@\" # Numeric or Aphabetic (default Numeric)\n$CTX_HOSTING_UNIT_PATH = \"@@{CTX_HOSTING_UNIT_PATH}@@\" # Customer to provide (Ex: XDHyp:\\HostingUnits\\NutanixResources - Can get the list using Get-Item XDHyp:\\HostingUnits\\*)\n$CTX_MASTER_IMAGE_PATH = $CTX_HOSTING_UNIT_PATH + \"\\\" + \"@@{SNAP_NAME}@@.template\" # XDHyp:\\HostingUnits\\SELab-Citrix-Desktops\\WinSer2016_SysPrepped_Snap_Base_0.template\n$MSFT_AD_DOMAIN = \"@@{MSFT_AD_DOMAIN}@@\"\nAdd-PSSnapin Citrix.*.Admin.V*\n\n\n#$brokerHypConnection = Get-BrokerHypervisorConnection\n$hostingUnit = Get-Item $CTX_HOSTING_UNIT_PATH\n\n# Start logged operation\n$loggingOp = Start-LogHighLevelOperation -Source 'Calm' `\n-Text \"Create Machine Catalog '$CTX_MACHINE_CATALOG_NAME'\"\n$loggingId = $loggingOp.Id\n\n# Create the broker catalog and the AD Identity account pool\n$catalog = New-BrokerCatalog -Name $CTX_MACHINE_CATALOG_NAME `\n-Description $CTX_MACHINE_CATALOG_DESCRIPTION `\n-AllocationType $CTX_MACHINE_CATALOG_ALLOCATION `\n-ProvisioningType $CTX_MACHINE_CATALOG_PROVISIONING `\n-SessionSupport $CTX_MACHINE_CATALOG_SESSION `\n-PersistUserChanges $CTX_MACHINE_CATALOG_PERSISTUSER `\n-Scope @() `\n-LoggingId $loggingId\n\n$adPool = New-AcctIdentityPool -IdentityPoolName $CTX_MACHINE_CATALOG_NAME `\n-NamingScheme $CTX_MACHINE_CATALOG_NAMING `\n-NamingSchemeType $CTX_MACHINE_CATALOG_NAMING_TYPE `\n-Domain $MSFT_AD_DOMAIN `\n-AllowUnicode `\n-LoggingId $loggingId\n\nSet-BrokerCatalogMetadata -CatalogId $catalog.Uid `\n-Name 'Citrix_DesktopStudio_IdentityPoolUid' `\n-Value $adPool.IdentityPoolUid `\n-LoggingId $loggingId\n###################################################################\n# Create the ProvisioningScheme and wait for it to complete (reporting progress)\n$provSchemeTaskID = New-ProvScheme -ProvisioningSchemeName $CTX_MACHINE_CATALOG_NAME `\n-HostingUnitUID $hostingUnit.HostingUnitUID `\n-IdentityPoolUID $adPool.IdentityPoolUid `\n-CleanOnBoot `\n-MasterImageVM $CTX_MASTER_IMAGE_PATH `\n-VMCpuCount $CTX_MACHINE_CATALOG_VCPU `\n-VMMemoryMB $CTX_MACHINE_CATALOG_RAM `\n-RunAsynchronously `\n-LoggingId $loggingId\n\n$provTask = Get-ProvTask -TaskID $provSchemeTaskID\n$taskProgress = 0\nWrite-Host \"Creating New ProvScheme\"\nwhile ($provTask.Active -eq $True)\n{\n    # catch an uninitialized task progress, this occurs until the product initialized the value\n    try {\n        $totalPercent = if ($provTask.TaskProgress){$provTask.TaskProgress} else {0}\n    } catch {}\n    Write-Progress -Activity \"Creating Provisioning Scheme:\" -Status \"$totalPercent% Complete:\" -PercentComplete $totalPercent\n    sleep 30\n    $provTask = Get-ProvTask -TaskID $provSchemeTaskID\n}\nWrite-Host \"New ProvScheme Creation Finished\"\n$provScheme = Get-ProvScheme -ProvisioningSchemeUID $provTask.ProvisioningSchemeUid\n$controllers = Get-BrokerController | select DNSName\nAdd-ProvSchemeControllerAddress -ProvisioningSchemeUID $provScheme.ProvisioningSchemeUID `\n-ControllerAddress $controllers `\n-LoggingId $loggingId\n###################################################################\n# Set the provisioning scheme id for the broker catalog\nSet-BrokerCatalog -InputObject $catalog `\n-ProvisioningSchemeId $provTask.ProvisioningSchemeUid `\n-LoggingId $loggingId\n###################################################################","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Cred_Citrix"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"Citrix_CTX_Create_Machine_Catalog_runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix_CTX_Create_Machine_Catalog_dag"},"variable_list":[]},"name":"CTX_Create_Machine_Catalog"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"Citrix_NTNX_VM_SNAPSHOT_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"exit_status":[],"script":"snap_name = \"@@{calm_application_name}@@-snap\"\nvm_uuid = \"@@{Windows.id}@@\"\ncluster_uuid = \"@@{Windows.platform[0].status.cluster_reference.uuid}@@\"\nuser = \"@@{Cred_PE_Calm.username}@@\"\npasswd = \"@@{Cred_PE_Calm.secret}@@\"\n\nurl = 'https:\/\/localhost:9440\/PrismGateway\/services\/rest\/v2.0\/snapshots?proxyClusterUuid={}'.format(cluster_uuid)\nheaders = {'Content-Type': 'application\/json', 'Accept':'application\/json'}\n\npayload = {\n  \"snapshot_specs\": [\n    {\n      \"snapshot_name\": snap_name,\n      \"vm_uuid\": vm_uuid\n    }\n  ]\n}\n\nr = urlreq(url, verb='POST', auth='BASIC', user=user, passwd=passwd, params=json.dumps(payload), headers=headers)\nif r.ok:\n  print(\"SNAP_NAME={}\".format(snap_name))\n  exit(0)\nelse:\n  print(\"Post request failed\", r.content)\n  exit(1)\n","eval_variables":["SNAP_NAME"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"Citrix_NTNX_VM_SNAPSHOT_runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix_NTNX_VM_SNAPSHOT_dag"},"variable_list":[]},"name":"NTNX_VM_SNAPSHOT"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"NTNX_VM_SNAPSHOT"},{"kind":"app_task","name":"CTX_Create_Machine_Catalog"}],"name":"Citrix_CommonPackageInstall_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"NTNX_VM_SNAPSHOT"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CTX_Create_Machine_Catalog"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"NTNX_VM_SNAPSHOT","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"Citrix_NTNX_VM_SNAPSHOT_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CTX_Create_Machine_Catalog","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"Citrix_CTX_Create_Machine_Catalog_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"Citrix_CommonPackageInstall_runbook","main_task_local_reference":{"kind":"app_task","name":"Citrix_CommonPackageInstall_dag"},"variable_list":[]},"name":"CommonPackageInstall"}],"depends_on_list":[{"kind":"app_service","name":"MDT"}],"name":"Citrix","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"SNAP_NAME","value":"","label":"","attrs":{"type":""},"is_hidden":true}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___create___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___create___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___create___dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for starting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___start___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___start___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___start___dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___stop___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___stop___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___stop___dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___delete___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___delete___dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for restarting an application","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___restart___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___restart___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___restart___dag"},"variable_list":[]},"name":"action_restart"},{"description":"System action for deleting an application. Does not delete created VMs","type":"system","critical":true,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT___soft_delete___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"MDT___soft_delete___runbook","main_task_local_reference":{"kind":"app_task","name":"MDT___soft_delete___dag"},"variable_list":[]},"name":"action_soft_delete"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"MDT_MDT_Set_MAC_Name_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"exit_status":[],"script":"$MDT_CUSTOM_SETTINGS_FILE_PATH = \"@@{MDT_DEPLOYMENT_SHARE}@@\\Control\\CustomSettings.ini\" \n$MAC_ADDRESS = \"@@{WindowsAHV.platform[0].status.resources.nic_list[0].mac_address}@@\"\n\"`r`n[$MAC_ADDRESS]`r`nOSDComputerName=@@{calm_application_name}@@\" | Add-Content -Path $MDT_CUSTOM_SETTINGS_FILE_PATH","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Cred_PE_Calm"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"MDT_MDT_Set_MAC_Name_runbook","main_task_local_reference":{"kind":"app_task","name":"MDT_MDT_Set_MAC_Name_dag"},"variable_list":[]},"name":"MDT_Set_MAC_Name"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"MDT_Set_MAC_Name"},{"kind":"app_task","name":"MDT_Monitor_Deployment"}],"name":"MDT_CommonPackageInstall_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"MDT_Set_MAC_Name"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"MDT_Monitor_Deployment"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT_Set_MAC_Name","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"MDT_MDT_Set_MAC_Name_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"MDT_Monitor_Deployment","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"MDT_MDT_Monitor_Deployment_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"MDT_CommonPackageInstall_runbook","main_task_local_reference":{"kind":"app_task","name":"MDT_CommonPackageInstall_dag"},"variable_list":[]},"name":"CommonPackageInstall"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"MDT_MDT_Monitor_Deployment_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Task1","attrs":{"exit_status":[],"script":"$MDT_DEPLOYMENT_SHARE = \"@@{MDT_DEPLOYMENT_SHARE}@@\" # (Ex: D:\\MDTBuildLab or \\\\MDT001\\MDT$)\n$MDT_VM_TEMPLATE_NAME = \"@@{calm_application_name}@@\"\n\n# --- DO NOT CHANGE AFTER HERE ---\n# ================================\n\n\n###################################################################\n# Preparing MDT phase, monitoring the DB to make sure the VM deployment is finished\nStart-Sleep 180\nWrite-Host \"Waiting for the VM to PXE boot to the MDT share and start the task sequence\"\n\nAdd-PSSnapin \"Microsoft.BDD.PSSNAPIN\" | Out-Null\nWrite-Host \"Loading MDT PowerShell cmdlets\"\n\nIf (!(Test-Path MDT:)) { New-PSDrive -Name MDT -Root $MDT_DEPLOYMENT_SHARE -PSProvider Microsoft.BDD.PSSNAPIN\\MDTPROVIDER | Out-Null } \n\n\nGet-MDTMonitorData -Path MDT: | Where-Object { $_.Name -eq $Name } | Out-Null\nWrite-Host \"Getting MDT Monitoring Data\"\n\nWrite-Host \"Waiting for task sequence to complete.\"\nDo {\n    $InProgress = Get-MDTMonitorData -Path MDT: | Where-Object { $_.Name -eq $MDT_VM_TEMPLATE_NAME }\n    If ( $InProgress.PercentComplete -lt 100 ) {\n        If ( $InProgress.StepName.Length -eq 0 ) { $StatusText = \"Waiting for update\" }\n        Start-Sleep -Seconds 5\n    }\n    Else {\n        Write-Progress -Activity \"Task sequence complete\" -PercentComplete 100\n    }\n}\nUntil ($InProgress.CurrentStep -eq $InProgress.TotalSteps)\nwrite-Host -message 'Task Sequence completed'","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"Cred_PE_Calm"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"MDT_MDT_Monitor_Deployment_runbook","main_task_local_reference":{"kind":"app_task","name":"MDT_MDT_Monitor_Deployment_dag"},"variable_list":[]},"name":"MDT_Monitor_Deployment"}],"depends_on_list":[],"name":"MDT","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"WindowsMAC","value":"","label":"","attrs":{"type":""},"is_hidden":true}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"WindowsAHV","readiness_probe":{"connection_type":"POWERSHELL","retries":"0","connection_protocol":"http","connection_port":5985,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"0","disable_readiness_probe":true,"login_credential_local_reference":{"kind":"app_credential","name":"Administrator"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"num_sockets":true,"memory_size_mib":true,"boot_config":true,"disk_list":{"0":{"disk_size_mib":true}}}}},"os_type":"Windows","create_spec":{"name":"@@{calm_application_name}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"dnd-jose.gomez","uuid":"e28bce98-3eef-4be7-8df9-bf9726dccba2"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":4,"gpu_list":[],"memory_size_mib":8192,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":null,"power_state":"ON","type":"","account_uuid":"4ad90864-dcc6-47d1-9dfb-9feede5927a5","boot_config":null,"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"MDT_Build_Lab_x64","uuid":"edc75259-e41b-4859-b0ea-5180324d5b6d"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"IDE"},"device_type":"CDROM"}},{"data_source_reference":null,"type":"","disk_size_mib":61440,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"CitrixStudio","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","connection_protocol":"http","connection_port":5985,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":true,"login_credential_local_reference":{"kind":"app_credential","name":"Cred_Citrix"}},"os_type":"Windows","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{CTX_ADMIN_ADDRESS}@@"},"variable_list":[]},{"description":"","action_list":[],"type":"EXISTING_VM","name":"DeploymentWorkbench","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","connection_protocol":"http","connection_port":5985,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"Cred_PE_Calm"}},"os_type":"Windows","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"@@{MDT_ADMIN_ADDRESS}@@"},"variable_list":[]}],"credential_definition_list":[{"username":"Administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Administrator","editables":{"username":true,"secret":true}},{"username":"sjlab\\administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Cred_Citrix","editables":{"username":true,"secret":true}},{"username":"svc_calm@ukdemo.local","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"Cred_PE_Calm","editables":{"username":true,"secret":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"CUSTOM","service_local_reference_list":[{"kind":"app_service","name":"Windows"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_Package1_action_install","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_Package1_action_install","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_Package1_action_install"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Windows"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_Package1_action_uninstall","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_Package1_action_uninstall","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_Package1_action_uninstall"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"CUSTOM","service_local_reference_list":[{"kind":"app_service","name":"Citrix"}],"name":"Package2","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_Package2_action_install","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_Package2_action_install","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_Package2_action_install"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Citrix"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_Package2_action_uninstall","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_Package2_action_uninstall","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_Package2_action_uninstall"},"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"CUSTOM","service_local_reference_list":[{"kind":"app_service","name":"MDT"}],"name":"Package3","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"CommonPackageInstall"}],"name":"Package3___install___dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CommonPackageInstall","attrs":{"type":"","inarg_list":[],"runbook_reference":{"kind":"app_runbook","name":"MDT_CommonPackageInstall_runbook"}},"timeout_secs":"0","type":"CALL_RUNBOOK","variable_list":[]}],"description":"","name":"Package3___install___runbook","main_task_local_reference":{"kind":"app_task","name":"Package3___install___dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"MDT"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"DAG_Task_for_Package_Package3_action_uninstall","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"Runbook_for_Package_Package3_action_uninstall","main_task_local_reference":{"kind":"app_task","name":"DAG_Task_for_Package_Package3_action_uninstall"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"eee8c0ac_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"WindowsAHV"},"options":{"type":""},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"8b1c1f67_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package2"}],"substrate_local_reference":{"kind":"app_substrate","name":"CitrixStudio"},"options":{"type":""},"variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"name":"ba70c687_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package3"}],"substrate_local_reference":{"kind":"app_substrate","name":"DeploymentWorkbench"},"options":{"type":""},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"AHV","variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_HOSTING_UNIT_PATH","value":"XDHyp:\\HostingUnits\\NutanixResources","label":"Citrix Hosting Units Path","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_NAMING_TYPE","value":"Numeric","label":"Machine catalog naming convention type","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["Numeric"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_NAMING","value":"Machine-###","label":"Machine catalog naming","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_RAM","value":"6","label":"Total memory (MB) on each machine","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"Single virtual socket and the number of vCPUs define the number of cores","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_VCPU","value":"2","label":"Total virtual CPUs on each machine","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_CREATE_VMS","value":"1","label":"How many virtual machines do you want to create?","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_PERSISTUSER","value":"Discard","label":"Citrix Machine Catalog Persistent Disk","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["Discard"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_SESSION","value":"SingleSession","label":"Citrix Machine Catalog Session Type","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["SingleSession"]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_PROVISIONING","value":"MCS","label":"Citrix Machine Catalog Provisioning Mode","attrs":{"type":""},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_ALLOCATION","value":"Random","label":"Citrix Machine Catalog Allocation Type","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["Random"]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_DESCRIPTION","value":"","label":"Citrix Machine Catalog Description","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_MACHINE_CATALOG_NAME","value":"","label":"Citrix New Machine Catalog Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"regex":{"should_validate":true,"value":"^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"},"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"CTX_ADMIN_ADDRESS","value":"192.168.122.228","label":"Citrix Studio IP Address","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"This can be a local folder in the MDT server, or a shared folder with the format \\\\hostname\\folder_name$","data_type":"BASE","type":"LOCAL","name":"MDT_DEPLOYMENT_SHARE","value":"D:\\MDTBuildLab","label":"MDT Deployment Share Path","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"MDT_ADMIN_ADDRESS","value":"192.168.4.174","label":"Microsoft Deployment Toolkit Server IP Address","attrs":{"type":""},"editables":{"value":true},"is_hidden":false},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"MSFT_AD_DOMAIN","value":"sjlab.local","label":"Active Directory Domain Name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"Administrator"},"type":"USER"},"name":"ntc-euc-template"},"api_version":"3.0","metadata":{"last_update_time":"1605090223964662","kind":"blueprint","spec_version":5,"creation_time":"1604773224656468","name":"ntc-euc-template"}}