{"status":{},"contains_secrets":false,"product_version":"2.9.8","spec":{"description":"","resources":{"client_attrs":{},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7debe36e_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"773f9252_runbook","main_task_local_reference":{"kind":"app_task","name":"7debe36e_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a994383a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"03213edf_runbook","main_task_local_reference":{"kind":"app_task","name":"a994383a_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"d2e4f050_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"14e6862d_runbook","main_task_local_reference":{"kind":"app_task","name":"d2e4f050_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9610dc6f_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"18967c29_runbook","main_task_local_reference":{"kind":"app_task","name":"9610dc6f_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7714b84a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"240095fd_runbook","main_task_local_reference":{"kind":"app_task","name":"7714b84a_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"Service","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AZURE_VM","name":"VM1","readiness_probe":{"connection_type":"SSH","retries":"5","connection_protocol":"","connection_port":22,"address":"@@{platform.publicIPAddressList[0]}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"cred_os"}},"editables":{"create_spec":{"resources":{"storage_profile":{"data_disk_list":true,"image_details":{"sku":true,"publisher":true,"version":true,"offer":true}},"hw_profile":{"vm_size":true},"nw_profile":{"nic_list":true}}}},"os_type":"Linux","create_spec":{"type":"PROVISION_AZURE_VM","name":"","resources":{"vm_name":"vm-@@{calm_unique_hash}@@-@@{calm_array_index}@@","storage_profile":{"is_managed":true,"image_details":{"sku":"7.6","publisher":"OpenLogic","offer":"CentOS","source_image_id":"","use_custom_image":false,"version":"7.6.201909120","type":""},"type":"","os_disk_details":{"size_in_gb":-1,"name":"os-@@{calm_unique_hash}@@-@@{calm_array_index}@@-disk","storage_name":"","storage_type":"","caching_type":"ReadWrite","type":"","create_option":"FromImage","lun":-1},"data_disk_list":[]},"nw_profile":{"nic_list":[{"nsg_name":"","vnet_name":"","subnet_id":"\/subscriptions\/575bd7ed-618c-4a20-a50b-d4501433f5d2\/resourceGroups\/UK\/providers\/Microsoft.Network\/virtualNetworks\/calmvn\/subnets\/default","nsg_id":"\/subscriptions\/575bd7ed-618c-4a20-a50b-d4501433f5d2\/resourceGroups\/UK\/providers\/Microsoft.Network\/networkSecurityGroups\/calmnsg","private_ip_info":{"ip_allocation_method":"Dynamic","ip_address":"","type":""},"nic_name":"nic-@@{calm_unique_hash}@@-@@{calm_array_index}@@-0","subnet_name":"","vnet_id":"\/subscriptions\/575bd7ed-618c-4a20-a50b-d4501433f5d2\/resourceGroups\/UK\/providers\/Microsoft.Network\/virtualNetworks\/calmvn","type":"","public_ip_info":{"ip_allocation_method":"Dynamic","dns_label":"dns-@@{calm_unique_hash}@@-@@{calm_array_index}@@-0","ip_name":"public-ip-@@{calm_unique_hash}@@-@@{calm_array_index}@@-0","type":""}}],"primary_nic":-1,"type":""},"resource_group":"UK","os_profile":{"secrets":[],"type":"","windows_config":{"winrm_listeners":[],"time_zone":"","additional_unattend_content":[],"provision_vm_agent":true,"auto_updates":false,"type":""},"linux_config":{"type":"","disable_password_auth":false,"public_keys":[],"custom_data":"#cloud-config\nhostname: @@{name}@@\nusers:\n  - name: @@{cred_os.username}@@\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\nchpasswd:\n  list: |\n    @@{cred_os.username}@@:@@{cred_os.secret}@@\n  expire: False\nssh_pwauth: True"}},"hw_profile":{"max_data_disk_count":4,"vm_size":"Standard_B2s","type":""},"location":"uksouth","availability_set_id":"","tag_list":[],"type":"","account_uuid":"1739d129-eecf-0bd6-1332-64f8e104ef93"}},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"cred_os","editables":{"username":true}}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"Service"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"983208a9_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7c8b7ee3_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"983208a9_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"135eb14b_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e8489117_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"135eb14b_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"d9a7e890_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"description":"","action_list":[{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Azure_Enable_VM_Backup"}],"name":"e42141e6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"Service"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Azure_Enable_VM_Backup","attrs":{"script":"# region headers\n# * author:     jose.gomez@nutanix.com\n# * version:    v1.0 - initial version\n# * date:       25\/03\/2020\n# task_name:    Azure_Enable_Backup\n# description:  Enable backup for an Azure VM\n# type:         Execute\n# input vars:   azure_subscription_id, azure_client_id, azure_tenant_id, azure_secret, azure_storage_account_name, az_recovery_services_vault_name, az_recovery_services_backup_policy_name\n# output vars:  none\n# endregion\n\n# region capture Calm variables\naz_subscription_id = '@@{azure_subscription_id}@@'\naz_client_id = '@@{azure_client_id}@@'\naz_tenant_id = '@@{azure_tenant_id}@@'\naz_secret = '@@{azure_secret}@@'\naz_resource_group_name = '@@{resource_group}@@'\naz_vm_name = '@@{name}@@'\naz_recovery_services_vault_name = '@@{azure_recovery_services_vault_name}@@'\naz_recovery_services_backup_policy_name = '@@{azure_recovery_services_backup_policy_name}@@'\n# endregion\n\n# region load Azure SDK libraries\nimport datetime\nfrom azure.common.credentials import ServicePrincipalCredentials\nfrom azure.mgmt.recoveryservicesbackup import RecoveryServicesBackupClient\nfrom azure.mgmt.recoveryservicesbackup.models import (AzureIaaSComputeVMProtectedItem, BackupRequestResource,\n                                                      IaasVMBackupRequest,\n                                                      IaasVMILRRegistrationRequest, IaasVMRestoreRequest,\n                                                      ILRRequestResource, JobStatus,\n                                                      OperationStatusValues, ProtectedItemResource, ProtectionState,\n                                                      RecoveryType,\n                                                      RestoreRequestResource,\n                                                      BackupManagementType)\n# endregion\n\n# region function - retrieve Azure credentials\ndef get_credentials():\n    subscription_id = az_subscription_id\n    credentials = ServicePrincipalCredentials(\n        client_id=az_client_id,\n        secret=az_secret,\n        tenant=az_tenant_id\n    )\n    return credentials, subscription_id\n# endregion\n\n# region function - Enable backup for Azure VM   \ndef enable_recovery_services_backup():\n    credentials, subscription_id = get_credentials()\n    backup_client = RecoveryServicesBackupClient(credentials, subscription_id)\n    \n    container_name = \"iaasvmcontainer;iaasvmcontainerv2;{};{}\".format(az_resource_group_name,az_vm_name)\n    fabric_name = \"Azure\"\n    protected_item_name = \"vm;iaasvmcontainerv2;{};{}\".format(az_resource_group_name,az_vm_name)\n    policy = backup_client.protection_policies.get(az_recovery_services_vault_name, az_resource_group_name, az_recovery_services_backup_policy_name)\n\n    response = backup_client.protection_containers.refresh(az_recovery_services_vault_name, az_resource_group_name, fabric_name, raw=True)\n\n    _get_operation_response(\n        response,\n        lambda operation_id: backup_client.protection_container_refresh_operation_results.get(\n            az_recovery_services_vault_name, az_resource_group_name, fabric_name, operation_id, raw=True,\n        ),\n        None,\n    )\n\n    iaasvm_odata_filter = \"backupManagementType eq '{}'\".format('AzureIaasVM')\n    protectable_items = backup_client.backup_protectable_items.list(az_recovery_services_vault_name, az_resource_group_name, filter=iaasvm_odata_filter, raw=True)\n\n    for protectable_item in protectable_items:\n        if protectable_item.name.lower() in container_name.lower():\n            desired_protectable_item = protectable_item.properties\n    \n    protected_item_resource = ProtectedItemResource(\n            properties=AzureIaaSComputeVMProtectedItem(policy_id=policy.id, source_resource_id=desired_protectable_item.virtual_machine_id)\n            )\n\n    response = backup_client.protected_items.create_or_update(\n            az_recovery_services_vault_name, az_resource_group_name, fabric_name, container_name, protected_item_name,\n            protected_item_resource, raw=True\n            )\n\n    job_response = _get_operation_response(\n        response,\n        lambda operation_id: backup_client.protected_item_operation_results.get(\n            az_recovery_services_vault_name, az_resource_group_name, fabric_name, container_name, protected_item_name, operation_id, raw=True,\n            ),\n        lambda operation_id: backup_client.protected_item_operation_statuses.get(\n            az_recovery_services_vault_name, az_resource_group_name, fabric_name, container_name, protected_item_name, operation_id,\n            ),\n        )\n\n    wait_for_job_completion(job_response.job_id)\n    \n    print('Backup enabled for {}'.format(az_vm_name))\n    exit(0)\n# endregion\n\n# region function - Helpers   \ndef _dummy_wait_and_return_true(timeout_in_sec):\n    sleep(timeout_in_sec)\n    return True\n\ndef wait_for_job_completion(job_id):\n    retry_action_with_timeout(\n        lambda: get_job_status(job_id),\n        lambda job_status: not is_job_in_progress(job_status),\n        3 * 60 * 60,  # 3 Hours\n        lambda status_code: _dummy_wait_and_return_true,\n        )\n\ndef get_job_status(job_id):\n    credentials, subscription_id = get_credentials()\n    backup_client = RecoveryServicesBackupClient(credentials, subscription_id)\n    \n    response = backup_client.job_details.get(az_recovery_services_vault_name, az_resource_group_name, job_id)\n    return response.properties.status\n\ndef is_job_in_progress(job_status):\n    in_progress = job_status in [JobStatus.in_progress.value, JobStatus.cancelling.value]\n    if in_progress:\n        sleep(60)\n    return in_progress\n\ndef time_in_sec():\n    return int(datetime.datetime.now().strftime(\"%s\"))\n\ndef retry_action_with_timeout(action, validator, timeout, should_retry):\n    end_time = time_in_sec() + timeout\n    result = None\n    validator_result = False if result is None else validator(result)\n\n    while time_in_sec() < end_time and not validator_result:\n        result = action()\n        validator_result = validator(result)\n\n    return result\n\ndef _get_operation_response(raw_response, get_operation_result_func, get_operation_status_func):\n    operation_id_url = raw_response.response.headers[\"Location\"]\n    operation_id = (operation_id_url.split('?'))[0].rsplit('\/')[-1]\n    operation_response = get_operation_result_func(operation_id)\n\n    while operation_response.response.status_code == 202:\n        sleep(5)\n        operation_response = get_operation_result_func(operation_id)\n\n    if get_operation_status_func:\n        operation_status_response = get_operation_status_func(operation_id)\n        return operation_status_response.properties\n\n    return operation_response\n# endregion\n\n# region execute function \nenable_recovery_services_backup()\n# endregion\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"4443e63c_runbook","main_task_local_reference":{"kind":"app_task","name":"e42141e6_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"azure_secret","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"azure_tenant_id","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"azure_client_id","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"SECRET","name":"azure_subscription_id","value":"","label":"","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"azure_recovery_services_backup_policy_name","value":"DailyPolicy","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"azure_recovery_services_vault_name","value":"vault450","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}}]},"name":"Enable Backup"}],"name":"Default","variable_list":[]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"cred_os"},"type":"USER"},"name":"jg-azureSdk-vmBackup"},"api_version":"3.0","metadata":{"last_update_time":"1585330804728260","kind":"blueprint","spec_version":18,"creation_time":"1585168468277585","categories":{"TemplateType":"Vm"},"name":"jg-azureSdk-vmBackup"}}